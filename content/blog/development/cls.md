---
title: 'CLS 성능 최적화하기'
date: 2023-11-14
description: 'Lighthouse 웹 성능 지표에 따라 프로젝트 최적화해보기'
tags: [Development]
thumbnail: /thumbnails/hello-world.jpg
---

## 성능 최적화를 하는 이유

웹 페이지가 얼마나 빨리 로딩되는지가 서비스 사용자 경험에 영향을 미친다. 결국 웹 성능 최적화 작업은 웹 서비스에 비즈니스의 성공, 비즈니스에 긍정적 기여에 직결될 수 있다.

## 이전 성능 최적화 도전

Lighthouse로 웹접근성과 SEO를 개선한 후, 성능 최적화를 하려고 했지만 실패했다. 3차 시도 후에 겨우 했다.

**첫 번째 시도 ❌**

- `React.lazy`, `Suspense`를 사용하여 코드 스플리팅

**두 번째 시도 ❌**

- `React.lazy`, `Suspense`를 사용하여 코드 스플리팅
- Vite manual Chunks를 사용하여 라이브러리 코드 스플리팅
- Vite에서 제공하는 `Imagemin`을 사용하여 assets 최적화
- 이미지 `webp`로 변환

최적화를 했지만 오히려 Lighthouse 점수가 떨어지는 상황이 발생해 충격을 금치 못하고...🤪 나는 최적화를 못하겠구나 생각이 들었다.

최적화를 공부해야겠다는 생각이 든 후에 <프론트엔드 성능 최적화 가이드> 책을 보고 공부했다.

**세 번째 시도 ✅**

내 문제는 **웹 성능 지표 하나하나에 집중하지 못했던 것**이다. 아는 최적화는 코드 스플리팅과 이미지 최적화라 그 두 개에만 집중하다보니 가장 큰 성능 문제를 보지 못했다.
Lighthouse 검사를 해보니 CLS(Cumulative Layout Shift), SI(Speed Index) 점수가 낮았다. CLS부터 성능 최적화를 했다.

## CLS(Cumulative Layout Shift)란?

CLS는 예상치 못한 레이아웃의 변경에 관한 점수다. 보고 있던 페이지에서 예상치 못한 레이아웃의 변경이 발생한다면 사용자가 클릭한 것이 다른 페이지로 이동하거나 시각적으로도 혼란스럽게 하는 등 사용자 경험을 저해한다. 사용자 경험을 좋게 하기 위해서는 사이트의 CLS 점수가 **0.1 이하**여야 한다.

모든 레이아웃의 변경이 나쁜 것은 아니다. 실제로 많은 동적 웹 애플리케이션에서 페이지 요소의 시작 위치를 자주 변경한다. 레이아웃의 변경은 **사용자가 예상하지 못한 경우에만 좋지 않다.** 반면 사용자 상호작용인 링크 클릭, 버튼 누르기, 검색창 입력 등에 대한 응답으로 발생하는 레이아웃의 변경은 일반적으로 문제가 되지 않는다. 또한 사용자 입력의 **500ms** 이내에 발생하는 레이아웃의 변경은 계산에서 제외될 수 있다.

<p align="center"><img src="/development/cls-google-example.gif"/></p>

위 구글에서 제시한 스크린캐스트를 보면 레이아웃의 예기치 않은 이동이 사용자가 원치 않는 주문을 실행하게 했다. 이처럼 순간적인 레이아웃 변화는 사용자의 의도와는 다른 동작을 하게 할 수 있다.

## 레이아웃의 이동을 발생시키는 원인

> - 사이즈가 미리 정의되지 않은 이미지 요소
> - 사이즈가 미리 정의되지 않은 광고 요소
> - 동적으로 삽입된 콘텐츠
> - FOIT / FOUT을 유발하는 웹 글꼴

## 실제 프로젝트 개선해보기

성능 개선 전 레이아웃 이동 살펴보기

<p align="center"><img src="/development/taing_cls_problem.gif"/></p>

먼저 위에 보이는 문제점으로는 크기가 없는 광고 팝업과 캐로셀 레이아웃의 잦은 변동이다.

특히 캐로셀 레이아웃의 경우, 아래와 같이 레이아웃이 변동됐다.

스켈레톤 UI ➡️ 데이터가 불러와져서 스켈레톤 UI가 사라짐 ➡️ 레이아웃과 이미지 사이즈가 미리 정해져있지 않아 레이아웃이 망가짐 ➡️ 이미지가 불러와지면 다시 레이아웃이 돌아옴

자세히 보면 메인 배너의 스켈레톤 UI 크기도 제대로 적용되지 않은 것을 확인할 수 있다😓

<p align="center"><img src="/development/performance_before.png"/></p>

성능 개선 전 CLS 점수를 보면 **2.283**이다. 보통 CLS는 0부터 1까지의 값을 가지며 레이아웃이 전혀 이동하지 않는 것을 0, 그 반대를 1로 계산한다. 구글에서 **0.1**을 권장하는데, 기존 프로젝트는 2.283이라는 나올 수 있는 점수가 맞는지도 궁금한 점수가 나왔기 때문에 개선이 필요할 만큼 레이아웃의 이동이 크다는 것을 알 수 있다.

**_레이아웃 이동 해결_**

레이아웃 이동은 대부분 사이즈가 미리 정의되어 있지 않은 요소 때문에 발생하기 때문에 **해당 요소의 사이즈를 미리 예측할 수 있거나 이미 알고 있다면 해당 사이즈만큼 공간을 확보해 놓는 것**이 주요 해결책이 된다.

이미지의 사이즈는 변할 가능성이 많기 때문에 단순히 너비와 높이를 고정하는 것이 아니라 이미지의 너비, 높이 비율로 공간을 잡아두면 된다.

**_이미지 크기를 비율로 공간을 확보하는 방법_**

> 1.  `padding`을 이용하여 박스를 만든 뒤, 그 안에 이미지를 `absolute`로 띄우는 방식
> 2.  `aspect-ratio`라는 CSS 속성 이용하기

<br/>

**_먼저 사용하는 이미지의 비율을 알아보자_**

개발자 도구에서 이미지 요소를 클릭해보면 `intrinsic aspect ratio`를 확인할 수 있는데 이게 `aspect-ratio`에 적용할 이미지의 비율이 된다.

<p align="center"><img src="/development/intrinsic_aspect_ratio.png"/></p>

여기서는 `92:133`이 된다.

<br/>

이미지 사이즈만큼 공간을 확보하는 두 가지 방법의 예시를 봐보자. 예시로 된 이미지 비율은 `16:9`다.

**1️⃣ `padding`을 이용하여 박스를 만든 뒤, 그 안에 이미지를 `absolute`로 띄우는 방식**

```html
<div class="wrapper">
  <img class="image" src="..." />
</div>
```

```css
.wrapper {
  position: relative;
  width: 160px;
  padding-top: 56.25%; /* 16:9 비율 */
}

.image {
  position: absolute;
  width: 100%;
  height: 100%;
  top: 0;
  left: 0;
}
```

이렇게 하면 wrapper의 너비인 160px의 56.2%만큼 상단 여백이 생긴다. 즉, 너비는 160px, 높이는 90px이 된다. 이 상태에서 이미지를 `absoulte` 주면 부모 요소인 `div`와 사이즈가 동일하게 맞춰진다.

하지만 이 방법은 `padding`의 퍼센트를 매번 계산해야 하고 코드가 직관적이지 않다는 문제점이 있다. 이러한 불편함 때문에 두 번째 방법이 나왔다.

**2️⃣ `aspect-ratio`라는 CSS 속성 이용하기**

```css
.wrapper {
  width: 100%;
  aspect-ratio: 16 / 9;
}

.image {
  width: 100%;
  height: 100%;
}
```

`padding`을 이용한 방법과 달리 코드가 간단하지만 최신 기술이기 때문에 호환성 문제가 있어 일부 브라우저 버전에서는 지원하지 않을 수 있다.

나는 `aspect-ratio`를 선택해서 개선했다. 팝업 이미지 부분과 스켈레톤 UI, 실제 데이터로 불러와지는 이미지 Wrapper에 `aspect-ratio`를 적용했다.

그 외에도 반응형이 자연스럽게 보이기 위한 `transition` 설정이 레이아웃 이동을 심각하게 발생시키고 있어 관련 코드를 제거했다.

## 결과

<p align="center"><img src="/development/taing_cls_problem_after.gif"/></p>

<p align="center"><img src="/development/performance_after.png"/></p>

CLS를 0으로 개선할 수 있었다! 🥳 개선 이전 메인 페이지를 다시 보니 개선된 페이지는 시각적으로 훨씬 안정적이라 느낄 수 있었다.

## 결론

> - 예상치 못한 레이아웃의 변경은 사용자에게 좋지 않은 경험을 준다.
> - CLS(Cumulative Layout Shift)란 레이아웃 이동에 관한 웹 성능 지표이며 0.1 이하여야 사용자 경험이 좋다고 할 수 있다.
> - CLS 점수 개선을 위해서는 이미지 요소의 사이즈만큼 공간을 미리 확보하는 것이 주요 해결책이다.
> - `padding`이나 `aspect-ratio`를 사용해서 미리 공간을 확보할 수 있다.

## 참고

- 📚 <프론트엔드 성능 최적화 가이드>, 유동균
- 🔗 https://web.dev/articles/cls?hl=ko
- 🔗 https://www.sktenterprise.com/bizInsight/blogDetail/dev/4486
- 🔗 https://yozm.wishket.com/magazine/detail/2036/
- 🔗 https://wit.nts-corp.com/2020/12/28/6240
